<clickhouse>
    <listen_host>0.0.0.0</listen_host>

    <!-- Local filesystem cache greatly speeds S3 reads/merges -->
    <filesystem_cache>
        <path>/var/lib/clickhouse/file_cache</path>
        <max_size>10Gi</max_size>
        <enable_cache_hits_threshold>0</enable_cache_hits_threshold>
    </filesystem_cache>

    <storage_configuration>
        <disks>
            <!-- Optional local disk (kept for compatibility/tools) -->
            <local_data_disk>
                <type>local</type>
                <path>/var/lib/clickhouse/data/</path>
            </local_data_disk>

            <!-- Primary S3 disk -->
            <s3_disk>
                <type>s3</type>
                <endpoint>https://nbg1.your-objectstorage.com/rybbit/clickhouse/</endpoint>
                <access_key_id from_env="S3_ACCESS_KEY"/>
                <secret_access_key from_env="S3_SECRET_KEY"/>
                <region from_env="S3_REGION"/>

                <!-- Prefer virtual addressing if provider supports it -->
                <use_virtual_addressing>true</use_virtual_addressing>

                <metadata_path>/var/lib/clickhouse/disks/s3_disk_metadata/</metadata_path>

                <!-- Concurrency: tune down if you see throttling -->
                <max_concurrent_upload_operations>32</max_concurrent_upload_operations>
                <max_download_threads>32</max_download_threads>

                <!-- Skip extra HEADs when perms are correct -->
                <skip_access_check>true</skip_access_check>
            </s3_disk>
        </disks>

        <policies>
            <!-- Keep tiered policy available if you ever want hot+cold again -->
            <tiered_s3_policy>
                <volumes>
                    <default>
                        <disk>default</disk>
                    </default>
                    <hot>
                        <disk>local_data_disk</disk>
                        <max_data_part_size_bytes>1073741824</max_data_part_size_bytes>
                        <move_factor>95</move_factor>
                    </hot>
                    <cold>
                        <disk>s3_disk</disk>
                    </cold>
                </volumes>
            </tiered_s3_policy>

            <!-- Pure S3 policy (now the default) -->
            <s3_policy>
                <volumes>
                    <default>
                        <disk>s3_disk</disk>
                    </default>
                </volumes>
            </s3_policy>
        </policies>
    </storage_configuration>

    <profiles>
        <default>
            <!-- Use S3-only by default -->
            <storage_policy>s3_policy</storage_policy>

            <!-- Runtime speed-ups (can also be in users.xml) -->
            <max_threads>32</max_threads>
            <async_insert>1</async_insert>
            <wait_for_async_insert>0</wait_for_async_insert>
            <max_insert_block_size>1048576</max_insert_block_size>
            <input_format_parallel_parsing>1</input_format_parallel_parsing>
            <use_filesystem_cache>1</use_filesystem_cache>

            <!-- Faster startup/part handling -->
            <max_part_loading_threads>16</max_part_loading_threads>

            <!-- Background pools drive merges/fetches -->
            <background_pool_size>32</background_pool_size>
            <background_move_pool_size>16</background_move_pool_size>
            <background_fetches_pool_size>32</background_fetches_pool_size>

            <!-- A bit more resilience with object storage -->
            <s3_max_single_read_retries>5</s3_max_single_read_retries>
        </default>
    </profiles>
</clickhouse>
